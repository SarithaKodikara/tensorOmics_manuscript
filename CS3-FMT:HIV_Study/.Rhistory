aes(x = time, y = mean, color = group),
size = 1.2, linetype = "twodash"
) +
facet_wrap2(
~ variable,
ncol = 5,
#scales = "free_y",
strip = strip_themed(
text_x = elem_list_text(
colour = facet_colors
),
background_x = elem_list_rect(
fill = "white",         # keep white background (or set to facet_colors)
color = "black"
)
)
) +
theme_bw(base_size = 12) +
scale_color_manual(values = c("A" = "blue", "B" = "orange")) +
scale_fill_manual(values = c("A" = "blue", "B" = "orange")) +
labs(
x = "Time",
y = "Abundance",
color = "Group",
fill  = "Group",
title = ""
) +
theme(
plot.title = element_text(hjust = 0.5, face = "bold"),
legend.position = "top",
axis.text.x = element_blank(),
axis.text.y = element_blank(),
axis.ticks.x = element_blank(),
axis.ticks.y = element_blank()
)
data_wide <- pivot_wider(
dat_long,
id_cols = c("id", "group", "time"),
names_from = "variable",
values_from = "value"
)
# Calculate n, p, t
n <- length(unique(data_wide$id))
p <- ncol(data_wide)-3
t <- length(unique(data_wide$time))
# Initialize data_array and group_array
data_array <- array(0, dim = c(n, p, t))
group_array <- array(NA, dim = c(n, 1, t))
# Loop over days
for (i in 1:t) {
day <- unique(data_wide$time)[i]
# Get index for individuals with the specific day
(indiv_index <- which(data_wide$time == day))
# Fill array and diet_array
data_array[,,i] <- as.matrix(data_wide[indiv_index, -c(1:3) ])
group_array[,,i] <- matrix(data_wide$group[indiv_index], ncol = 1)
}
tplsda_res<-tplsda(data_array, group_array[,,1],
ncomp = 3)
res_df<-data.frame(Group=group_array[,,1],
PC1=tplsda_res$x_projected[,1],
PC2=tplsda_res$x_projected[,2],
PC3=tplsda_res$x_projected[,3])
custom_colors <- c("A" = "blue", "B" = "orange")
# Plot tPLS-DA results (Sample plot)
ggplot(res_df, aes(x=PC1, y=PC2, color=Group))+
geom_point(size=2)+
ggtitle("")+
theme_bw()+
scale_color_manual(values = custom_colors)+
xlab("Comp1")+
ylab("Comp2")+
theme(plot.title = element_text(hjust = 0.5, size=16, face="bold"),
text = element_text(size=9),
legend.text = element_text(size=6),
legend.position = "none",
axis.text.x = element_blank(),
axis.text.y = element_blank(),
axis.ticks.x = element_blank(),
axis.ticks.y = element_blank())
# Loading plot for component 1
loadingPlot(loadings = tplsda_res$x_loadings,  top=5, data_wide,
comp = 1, negGroup = c("A"),
posGroup = c("B"))
# Loading plot function
loadingPlot<-function(loadings, top=8 ,merged_df,comp= 1,
negGroup=NULL, posGroup=NULL){
# Extract loadings for the specified component
loadings_cmp <- loadings[, comp]
names(loadings_cmp)<-colnames(merged_df[, -c(1:3) ])
# Calculate the absolute values and sort the indices based on absolute values
sorted_indices<- order(abs(loadings_cmp), decreasing = TRUE)
# Sort the categories and values based on the sorted indices
sorted_comp <- colnames(merged_df[, -c(1:3) ])[sorted_indices[1:top]]
sorted_loadings_comp <- loadings_cmp[sorted_comp[1:top]]
max_loading<- max(abs(sorted_loadings_comp))
# Create a temporary data frame for plotting
tmp_df <- data.frame(
OTU = sorted_comp,
loading = sorted_loadings_comp
)
tmp_df$OTU<- factor(tmp_df$OTU, levels = sorted_comp)
# Define spacing factor for gaps (increase this to increase gap)
gap_spacing <- 1.1  # 1.0 = original, 1.5 = 50% more space, 2.0 = double space
# Assign sign and y-position for each category with increased spacing
tmp_df <- tmp_df %>%
mutate(sign = ifelse(loading >= 0, "positive", "negative")) %>%
mutate(ypos = (as.numeric(OTU) - 1) * gap_spacing + 1)
# Prepare data for plotting
merged_df_sel <-merged_df[,c("group", "time", "id", sorted_comp)]
merged_df_mean <- merged_df_sel %>%
summarise(
.by = c(group, time),                 # grouping done here
across(
all_of(sorted_comp),
~ mean(.x, na.rm = TRUE),
.names = "{.col}"                      # clearer column names
)
)
# Reshape data to long format for ggplot
long_dat <-pivot_longer(
merged_df_mean,
cols = -c(group, time),
names_to = "OTU",
values_to = "median_value"
)
long_dat$OTU <- factor(long_dat$OTU, levels = sorted_comp)
# Assign y-position for each category with increased spacing
long_dat <- long_dat %>% mutate(ypos = (as.numeric(OTU) - 1) * gap_spacing + 1)
# Create a vector of y positions for the axis breaks
y_breaks <- (0:(top-1)) * gap_spacing + 1
# Merge with tmp_df to get loading information
long_dat <- long_dat %>%
left_join(tmp_df%>%select(OTU, loading), by = "OTU")%>%
mutate(sign_type = ifelse(loading >= 0, "positive", "negative"),
alpha_label = ifelse((sign_type == "positive" & group %in% posGroup), "High alpha",
ifelse((sign_type == "negative" & group %in% negGroup), "High alpha", "Low alpha")))%>%
group_by(OTU) %>%
mutate(value_scaled = rescale(median_value, to = c(unique(ypos) - 0.4, unique(ypos) + 0.4))) %>%
mutate(time = rescale(time, to = c(0, max_loading)))%>%
ungroup()
# Plot
custom_colors <- c("A" = "blue", "B" = "orange")
P<-ggplot(long_dat, aes(x = time)) +
geom_rect(data = tmp_df,
aes(xmin = pmin(0, -abs(loading)/3), xmax = pmax(0, -abs(loading)),
ymin = ypos - 0.4, ymax = ypos + 0.4, fill = sign),
alpha = 0.8, inherit.aes = FALSE)+
scale_y_continuous(breaks = y_breaks, labels = sorted_comp) +
scale_fill_manual(
values = c(positive = "#e39894" , negative = "#8fafd9"),
name   = "Loading"
) +
guides(fill = guide_legend(reverse = TRUE))+
ggnewscale::new_scale_fill() +
geom_ribbon(aes(ymin = ypos - 0.4, ymax = ypos + 0.4,
group = interaction(group, OTU),
fill = sign_type),
alpha = 0.02, show.legend = FALSE) +
scale_fill_manual(
values = c(positive ="red", negative = "blue"),
name = "Loading"
)+
geom_line(aes(y = value_scaled,
group = interaction(group, OTU),
colour = group,
linetype = alpha_label,
alpha = alpha_label),
linewidth   = 1)+
scale_color_manual(values = custom_colors, name = "Group") +
scale_alpha_manual(values = c("High alpha" = 1, "Low alpha" = 0.35), guide = "none") +
scale_linetype_manual(values = c("High alpha" = 1, "Low alpha" = 1), guide = "none") +
scale_x_continuous(
breaks = waiver(),
labels = function(b) ifelse(b == 0, "0", "")
) +
labs(y = "",
title = "") +
theme_minimal() +
guides(
colour = guide_legend(override.aes = list(size = 2)),
fill   = guide_legend(override.aes = list(size = 5)),
colour = guide_legend(nrow = 2),
fill   = guide_legend(nrow = 2)
) +
theme(
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
# axis.line.x = element_line(),
legend.position = "bottom",
plot.margin = margin(20, 10, 60, 10),
axis.text = element_text(size = 12),
axis.text.y = element_text(colour = "brown2") ,
legend.text = element_text(size = 10),
legend.title = element_text(size = 12),
legend.key.size = unit(1.5, "lines")
) +
#annotate("text", x = max_loading/2, y = min(tmp_df$ypos) - 0.6, label = "Time", size = 4.5) +
#annotate("text", x = (-max_loading)/5-0.001, y = min(tmp_df$ypos) - 0.6, label = "|Loading|", size = 4.5) +
geom_vline(xintercept = 0, colour = "black", linetype = "dashed") +
labs(x = NULL)
return(P)
}
# Loading plot for component 1
loadingPlot(loadings = tplsda_res$x_loadings,  top=5, data_wide,
comp = 1, negGroup = c("A"),
posGroup = c("B"))
ggplot() +
geom_point(data = dat_long,
aes(x = time, y = value, color = group),
alpha = 0.3, size = 1) +
geom_line(
data = dat_long,
aes(x = time, y = value, color = group, group = interaction(id, group)),
alpha = 0.3, size = 0.6
) +
geom_ribbon(
data = group_summ,
aes(x = time, ymin = lo, ymax = hi, fill = group),
alpha = 0.20, color = NA
) +
geom_line(
data = group_summ,
aes(x = time, y = mean, color = group),
size = 1.2, linetype = "twodash"
) +
facet_wrap2(
~ variable,
ncol = 5,
#scales = "free_y",
strip = strip_themed(
text_x = elem_list_text(
colour = facet_colors
),
background_x = elem_list_rect(
fill = "white",         # keep white background (or set to facet_colors)
color = "black"
)
)
) +
theme_bw(base_size = 12) +
scale_color_manual(values = c("A" = "blue", "B" = "orange")) +
scale_fill_manual(values = c("A" = "blue", "B" = "orange")) +
labs(
x = "Time",
y = "Abundance",
color = "Group",
fill  = "Group",
title = ""
) +
theme(
plot.title = element_text(hjust = 0.5, face = "bold"),
legend.position = "top",
axis.text.x = element_blank(),
axis.text.y = element_blank(),
axis.ticks.x = element_blank(),
axis.ticks.y = element_blank()
)
ggplot() +
geom_point(data = dat_long,
aes(x = time, y = value, color = group),
alpha = 0.3, size = 1) +
geom_line(
data = dat_long,
aes(x = time, y = value, color = group, group = interaction(id, group)),
alpha = 0.3, size = 0.6
) +
geom_ribbon(
data = group_summ,
aes(x = time, ymin = lo, ymax = hi, fill = group),
alpha = 0.20, color = NA
) +
geom_line(
data = group_summ,
aes(x = time, y = mean, color = group),
size = 1.2, linetype = "twodash"
) +
facet_wrap2(
~ variable,
ncol = 5,
#scales = "free_y",
strip = strip_themed(
text_x = elem_list_text(
colour = facet_colors
),
background_x = elem_list_rect(
fill = "white",         # keep white background (or set to facet_colors)
color = "black"
)
)
) +
theme_bw(base_size = 12) +
scale_color_manual(values = c("A" = "blue", "B" = "orange")) +
scale_fill_manual(values = c("A" = "blue", "B" = "orange")) +
labs(
x = "Time",
y = "Abundance",
color = "Group",
fill  = "Group",
title = ""
) +
theme(
plot.title = element_text(hjust = 0.5, face = "bold"),
legend.position = "top",
axis.text.x = element_blank(),
axis.text.y = element_blank(),
axis.ticks.x = element_blank(),
axis.ticks.y = element_blank(),
panel.grid.minor = element_blank()
)
ggplot() +
geom_point(data = dat_long,
aes(x = time, y = value, color = group),
alpha = 0.3, size = 1) +
geom_line(
data = dat_long,
aes(x = time, y = value, color = group, group = interaction(id, group)),
alpha = 0.3, size = 0.6
) +
geom_ribbon(
data = group_summ,
aes(x = time, ymin = lo, ymax = hi, fill = group),
alpha = 0.20, color = NA
) +
geom_line(
data = group_summ,
aes(x = time, y = mean, color = group),
size = 1.2, linetype = "twodash"
) +
facet_wrap2(
~ variable,
ncol = 5,
#scales = "free_y",
strip = strip_themed(
text_x = elem_list_text(
colour = facet_colors
),
background_x = elem_list_rect(
fill = "white",         # keep white background (or set to facet_colors)
color = "black"
)
)
) +
theme_bw(base_size = 12) +
scale_color_manual(values = c("A" = "blue", "B" = "orange")) +
scale_fill_manual(values = c("A" = "blue", "B" = "orange")) +
labs(
x = "Time",
y = "Abundance",
color = "Group",
fill  = "Group",
title = ""
) +
theme(
plot.title = element_text(hjust = 0.5, face = "bold"),
legend.position = "top",
axis.text.x = element_blank(),
axis.text.y = element_blank(),
axis.ticks.x = element_blank(),
axis.ticks.y = element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
)
ggplot() +
geom_point(data = dat_long,
aes(x = time, y = value, color = group),
alpha = 0.3, size = 1) +
geom_line(
data = dat_long,
aes(x = time, y = value, color = group, group = interaction(id, group)),
alpha = 0.3, size = 0.6
) +
geom_ribbon(
data = group_summ,
aes(x = time, ymin = lo, ymax = hi, fill = group),
alpha = 0.20, color = NA
) +
geom_line(
data = group_summ,
aes(x = time, y = mean, color = group),
size = 1.2, linetype = "twodash"
) +
facet_wrap2(
~ variable,
ncol = 2,
#scales = "free_y",
strip = strip_themed(
text_x = elem_list_text(
colour = facet_colors
),
background_x = elem_list_rect(
fill = "white",         # keep white background (or set to facet_colors)
color = "black"
)
)
) +
theme_bw(base_size = 12) +
scale_color_manual(values = c("A" = "blue", "B" = "orange")) +
scale_fill_manual(values = c("A" = "blue", "B" = "orange")) +
labs(
x = "Time",
y = "Abundance",
color = "Group",
fill  = "Group",
title = ""
) +
theme(
plot.title = element_text(hjust = 0.5, face = "bold"),
legend.position = "top",
axis.text.x = element_blank(),
axis.text.y = element_blank(),
axis.ticks.x = element_blank(),
axis.ticks.y = element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
)
ggplot() +
geom_point(data = dat_long,
aes(x = time, y = value, color = group),
alpha = 0.3, size = 1) +
geom_line(
data = dat_long,
aes(x = time, y = value, color = group, group = interaction(id, group)),
alpha = 0.3, size = 0.6
) +
geom_ribbon(
data = group_summ,
aes(x = time, ymin = lo, ymax = hi, fill = group),
alpha = 0.20, color = NA
) +
geom_line(
data = group_summ,
aes(x = time, y = mean, color = group),
size = 1.2, linetype = "twodash"
) +
facet_wrap2(
~ variable,
ncol = 5,
#scales = "free_y",
strip = strip_themed(
text_x = elem_list_text(
colour = facet_colors
),
background_x = elem_list_rect(
fill = "white",         # keep white background (or set to facet_colors)
color = "black"
)
)
) +
theme_bw(base_size = 12) +
scale_color_manual(values = c("A" = "blue", "B" = "orange")) +
scale_fill_manual(values = c("A" = "blue", "B" = "orange")) +
labs(
x = "Time",
y = "Abundance",
color = "Group",
fill  = "Group",
title = ""
) +
theme(
plot.title = element_text(hjust = 0.5, face = "bold"),
legend.position = "top",
axis.text.x = element_blank(),
axis.text.y = element_blank(),
axis.ticks.x = element_blank(),
axis.ticks.y = element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
)
View(to_long)
load("/Users/skodikara/Downloads/bioreactor.RData")
metadata
View(OTU_metadata)
View(metadata_GCMS)
?diablo
library(mixOmics)
?diablo
?block.plsda
library('lmms')
data(kidneySimTimeGroup)
# running for samples in group 1
G1 <- which(kidneySimTimeGroup$group=="G1")
testLMMSpline<- lmmSpline(data=kidneySimTimeGroup$data[G1,],time=kidneySimTimeGroup$time[G1],
sampleID=kidneySimTimeGroup$sampleID[G1])
summary(testLMMSpline)
?lmmSpline
data(kidneySimTimeGroup)
# running for samples in group 1
G1 <- which(kidneySimTimeGroup$group=="G1")
testLMMSpline<- lmmSpline(data=kidneySimTimeGroup$data[G1,],time=kidneySimTimeGroup$time[G1],
sampleID=kidneySimTimeGroup$sampleID[G1])
summary(testLMMSpline)
R.version
library(mixOmics)
?plsda
setwd("~/Library/CloudStorage/OneDrive-TheUniversityofMelbourne/Documents/ALL/PostDoc/tensorPLS/tensorOmics/CS3")
ko_raw <- read_tsv("data/ko_relabundance.tsv", show_col_types = FALSE)
library(mixOmics)
library(readr)
library(dplyr)
library(stringr)
library(tibble)
library(readxl)
ko_raw <- read_tsv("data/ko_relabundance.tsv", show_col_types = FALSE)
ko_info <- select(ko_raw, 1:3)    # KO ID + functional annotation
ko_data <- ko_raw %>%
select(-1:-3) %>%
t()
View(ko_data)
rowSums(ko_data)
1e+06
View(ko_data)
